{% extends "base.html" %}

{% load django_bootstrap5 %}
{}

{% block title %}
{% if form.initial %}
Edit {{ form.name.value }}
{% else %}
New schema
{% endif %}
{% endblock %}

{% block content %}
<form action="" method="POST" id="schemaForm">
    <h2 class="d-inline-block">
        {% if form.initial %}
        Edit {{ form.name.value }}
        {% else %}
        New schema
        {% endif %}
    </h2>
    {% bootstrap_button id="schemaSubmitBtn" button_type="submit" content="Submit" extra_classes="float-end" %}
    {% bootstrap_form form wrapper_class="w-50" %}
    {% comment %} {% bootstrap_form_errors form type="fields" %} {% endcomment %}


    {% csrf_token %}
    <div id="schemaFields" class="mt-3">
        <h2>Schema columns</h2>
        <ul class="list-unstyled text-danger">
            {% for error in form.columns.errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
        {% for column_formset in form.column_formsets %}
            {{ column_formset.management_form }}
            {% for column_form in column_formset %}
                {% include "schema/fieldForm.html" with fieldForm=column_form %}
            {% endfor %}
        {% endfor %}
    </div>
</form>

<form id="fieldSelectorForm" class="border rounded p-2">
    {% bootstrap_form field_select_form layout="horizontal" %}
    {% bootstrap_button id='addFieldBtn' button_type="submit" content="Add Field" %}
</form>

<div id="fieldTemplates">
    {% for fieldLabel, fieldForm in field_select_form.column_form_templates %}
    {% with 'style="display: none;" id="'|add:fieldLabel|add:'"'|safe as wrapper_tags %}
    {% include "schema/fieldForm.html" %}
    {% endwith %}
    {% endfor %}
</div>


<script>
    'use strict'
    
    function deleteField(event) {
        event.preventDefault() // othervise page scrolls up for some reason
        let column = event.target.parentElement
        //debugger;
        let delete_checkbox = column.querySelector('input[name$="DELETE"]')
        delete_checkbox.value = true
        column.hidden = true
        
    }

    //debugger; 
    const total_form_inputs = document.querySelectorAll('input[name$=TOTAL_FORMS]')
    let FORMS_TOTAL = Object.create(null)
    for (let type of total_form_inputs) {
        let name = type.name.replace('-TOTAL_FORMS', '')
        FORMS_TOTAL[name] = Number(type.value)
    }

    let schemaFieldsDiv = document.getElementById('schemaFields')

    document.getElementById('addFieldBtn').addEventListener('click', function (target) {
        let fieldSelectorForm = document.getElementById('fieldSelectorForm')
        target.preventDefault()

        if (!fieldSelectorForm.checkValidity()) {
            fieldSelectorForm.reportValidity()
            return;
        }

        // return;
        //fieldSelectorForm.preventDefault()
        //debugger; 

        // get new field config
        let fieldSelectorData = new FormData(fieldSelectorForm)
        let selectedType = fieldSelectorData.get('type');
        let fieldName = fieldSelectorData.get('name');
        let fieldOrder = fieldSelectorData.get('order');

        // get new field
        let fieldTemplates = document.getElementById('fieldTemplates')
        let fieldForm = fieldTemplates.querySelector('#' + selectedType).cloneNode(true)
        fieldForm.removeAttribute('id')
        fieldForm.style.display = ""

        // set correct input ids assuming there are only inputs or selects 
        let inputs = fieldForm.querySelectorAll('input')
        //debugger;
        let index = FORMS_TOTAL[selectedType]++
        for (let input of inputs) {
            let label = fieldForm.querySelector('label[for="' + input.id + '"]')
            input.id = input.id.replace('!', index)
            input.name = input.name.replace('!', index)
            label.setAttribute('for', input.id)
        }

        let selects = fieldForm.querySelectorAll('select')
        for (let select of selects) {
            let label = fieldForm.querySelector('label[for="' + select.id + '"]')
            select.id = select.id.replace('!', index)
            select.name = select.name.replace('!', index)
            label.setAttribute('for', select.id)
        }

        // set field's name and order
        fieldForm.querySelector('input[name$="name"]').value = fieldName
        fieldForm.querySelector('input[name$="order"]').value = fieldOrder

        // add field to the form
        schemaFieldsDiv.appendChild(fieldForm)
    })

    let schemaForm = document.getElementById('schemaForm')
    schemaForm.addEventListener('submit', function (target) {
        // target.preventDefault()
        for (let type of total_form_inputs) {
            type.value = FORMS_TOTAL[type.name.replace('-TOTAL_FORMS', '')]
        }
        console.log(FORMS_TOTAL);
    })
</script>

{% endblock %}