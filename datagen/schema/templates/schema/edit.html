{% extends "base.html" %}

{% load django_bootstrap5 %}

{% block content %}
<form action="" method="POST" id="schemaForm">
    <h2 class="d-inline-block mb-3">New schema</h2>
    {% bootstrap_button id="schemaSubmitBtn" button_type="submit" content="Submit" extra_classes="float-end" %}
    {% bootstrap_form form wrapper_class="w-50" %}
    {% csrf_token %}
    <div id="schemaFields" class="mt-3">
        <h2>Schema columns</h2>
        {% for fieldForm in form.field_forms %}
        {% include "schema/fieldForm.html" %}
        {% endfor %}
    </div>
</form>

<form id="fieldSelectorForm" class="border rounded p-2">
    {% bootstrap_form fieldSelectForm layout="horizontal" %}
    {% bootstrap_button id='addFieldBtn' button_type="submit" content="Add Field" %}
</form>

{% for fieldName, fieldForm in form.fieldFormsTemplates.items %}
{% with 'style="display: none;" id='|add:fieldName|add:"_fieldType"|safe as wrapper_tags %}
{% include "schema/fieldForm.html" %}
{% endwith %}
{% endfor %}


<script>
    'use strict';

    let schemaFieldsDiv = document.getElementById('schemaFields')

    document.getElementById('addFieldBtn').addEventListener('click', function(target) {
        target.preventDefault()

        // get new field config
        let fieldSelectorData = new FormData(document.getElementById('fieldSelectorForm'))
        let selectedType = fieldSelectorData.get('type');
        let fieldName = fieldSelectorData.get('name');
        let fieldOrder = fieldSelectorData.get('order');

        // get new field
        let fieldForm = document.getElementById(selectedType + '_fieldType').cloneNode(true)
        fieldForm.removeAttribute('id')
        fieldForm.style.display = ""

        // set field's name and order
        fieldForm.querySelector('input[name="name"]').value = fieldName
        fieldForm.querySelector('input[name="order"]').value = fieldOrder

        // add field to the form
        schemaFieldsDiv.appendChild(fieldForm)
    })

    let schemaForm = document.getElementById('schemaForm')
    schemaForm.addEventListener('submit', function(target) {
        // target.preventDefault()
        let fieldsData = new Array()
        for (let field of schemaFieldsDiv.children) {
            let fieldData = Object.create(null)

            let inputs = field.querySelectorAll('input')
            for (let input of inputs) {
                fieldData[input.name] = input.value
            }

            let selects = field.querySelectorAll('select')
            for (let select of selects) {
                fieldData[select.name] = select.value
            }

            if (Object.keys(fieldData).length) {
                fieldsData.push(fieldData)
            }
        }
        console.log(fieldsData)
        schemaForm.querySelector('#id_fields').value = JSON.stringify(fieldsData)
        schemaFieldsDiv.remove()
    })
</script>

{% endblock %}